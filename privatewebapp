const express = require('express');
const mongoose = require('mongoose');
const bodyParser = require('body-parser');
const jwt = require('jsonwebtoken');
const authController = require('./controllers/authController');

require('dotenv').config(); 

const app = express();
const PORT = process.env.PORT || 3000;

// Middleware
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true }));

// Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ (Ù†ÛŒØ§Ø² Ø¨Ù‡ MONGODB_URI Ø¯Ø± ÙØ§ÛŒÙ„ .env)
mongoose.connect(process.env.MONGODB_URI)
  .then(() => console.log('âœ… Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ²'))
  .catch(err => {
    console.error('âŒ Ø®Ø·Ø§ÛŒ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³:', err);
  });

// ðŸ”’ Middleware Ø§Ù…Ù†ÛŒØªÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§ÙØ¸Øª Ø§Ø² Ù…Ø³ÛŒØ±Ù‡Ø§
const authMiddleware = (req, res, next) => {
    const authHeader = req.headers.authorization;
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
        return res.status(401).send('ðŸš« Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ù…Ù†ÙˆØ¹. ØªÙˆÚ©Ù† Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.');
    }

    const token = authHeader.split(' ')[1];
    try {
        const decoded = jwt.verify(token, process.env.JWT_SECRET); 
        req.userId = decoded.userId; 
        next();
    } catch (ex) {
        res.status(400).send('ØªÙˆÚ©Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø± ÛŒØ§ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡.');
    }
};

// --- ØªØ¹Ø±ÛŒÙ Ù…Ø³ÛŒØ±Ù‡Ø§ ---
app.post('/register', authController.register);
app.post('/login', authController.login);

// ðŸš€ Ù…Ø³ÛŒØ± Ø®ØµÙˆØµÛŒ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ 
app.get('/dashboard', authMiddleware, (req, res) => {
    res.status(200).json({
        message: "Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø®ØµÙˆØµÛŒ Ø´Ù…Ø§ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!",
        data: `Ø´Ù…Ø§ Ø§Ú©Ù†ÙˆÙ† Ø¨Ø§ Ø§Ù…Ù†ÛŒØª Ú©Ø§Ù…Ù„ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯. Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ: ${req.userId}`
    });
});

// --- Ø´Ø±ÙˆØ¹ Ø³Ø±ÙˆØ± ---
app.listen(PORT, () => {
    console.log(`Ø³Ø±ÙˆØ± Ø¯Ø± Ù¾ÙˆØ±Øª ${PORT} Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ Ø§Ø³Øª.`);
});
